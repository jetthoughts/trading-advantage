/**
 * 
 * MemberMouse(TM) (http://www.membermouse.com) 
 * (c) MemberMouse, LLC. All rights reserved.
 */
class MM_CheckoutView extends MM_View
{
	public static $MM_JSACTION_APPLY_COUPON = "applyCoupon";
	
	public function performAction($post) 
	{	
		$response = parent::performAction($post);
		
		if(!($response instanceof MM_Response))
		{
			switch($post[self::$MM_JSACTION]) 
			{	
				case self::$MM_JSACTION_APPLY_COUPON:
					return $this->applyCoupon($post);
				
				default:
					return new MM_Response($response);
			}
		}
		else 
		{
			return $response;
		}
	}
	
	public function applyCoupon($post)
	{
		$result = new stdClass();
		$result->message = "";
		$result->isError = "0";
		$result->discount = "0.00";
		
		$couponCode = (isset($post["coupon_code"])) ? $post["coupon_code"] : MM_Session::value(MM_Session::$KEY_LAST_COUPON_VALUE);
		$coupon = MM_Coupon::getDataByCode($couponCode);
		
		if($coupon->isValid())
		{
			if(MM_Coupon::hasAvailableCoupon($couponCode))
			{
				$hasProduct = false;
				
				if(isset($post["product_id"]) && intval($post["product_id"]) > 0)
				{
					if($coupon->hasProduct($post["product_id"]))
					{
						$hasProduct = true;
					}
				}
					
				if($hasProduct)
				{
					MM_Session::value(MM_Session::$KEY_LAST_COUPON_VALUE, $couponCode);
		
					if(isset($post["product_price"]))
					{
						$discountedPrice = $this->getDiscountPrice($coupon, $post["product_price"]);
						
						$result->message = "Coupon applied successfully";
						
						if($discountedPrice != MM_Coupon::$TYPE_FREE)
						{
							$result->discount = floatval($post["product_price"]) - floatval($discountedPrice);
						}
						else
						{
							$result->discount = MM_Coupon::$TYPE_FREE;
						}
					}
					else
					{
						$result->message = "Invalid coupon code";
						$result->isError = "1";
					}
				}
				else
				{
					$result->message = "This coupon cannot be used for this product";
					$result->isError = "1";
				}
			}
			else
			{
				$result->message = "This coupon is no longer valid";
				$result->isError = "1";
			}
		}
		else
		{
			if(isset($post["coupon_code"]) && !empty($post["coupon_code"]))
			{
				$result->message = "Invalid coupon code";
				$result->isError = "1";
			}
			
			MM_Session::value(MM_Session::$KEY_LAST_COUPON_VALUE, $couponCode);
		}
		
		if($result->isError == "1")
		{
			MM_Session::clear(MM_Session::$KEY_LAST_COUPON_VALUE);
		}
		
		return new MM_Response(json_encode($result));
	}
	
	private function getDiscountPrice(MM_Coupon $coupon, $productPrice)
	{	
		if($coupon->isValid())
		{
			$value = $productPrice;
			$discount = $coupon->getCouponValue();
			
			if($coupon->getCouponType() == MM_Coupon::$TYPE_PERCENTAGE)
			{
				$value = $productPrice - ($productPrice * ($discount/100));
			}
			else if($coupon->getCouponType() == MM_Coupon::$TYPE_DOLLAR)
			{
				$value = $productPrice - $discount;
			}
			else if($coupon->getCouponType() == MM_Coupon::$TYPE_FREE)
			{
				return MM_Coupon::$TYPE_FREE;
			}
			
			return number_format($value, 2, '.', '');
		}
		
		return $productPrice;
	}
}
