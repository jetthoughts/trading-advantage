/**
 *
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 */

class MM_EventLog extends MM_Entity
{
	public static $EVENT_TYPE_PAGE_ACCESS = "page-access";
	public static $EVENT_TYPE_LOGIN = "login";
	
	public static $PARAM_PAGE_ID = "page-id";
	
	private $eventType = "";
	private $userId = "";
	private $url = "";
	private $referrer = "";
	private $additionalParams = array();
	private $ip = "";
	
	public function getData()
	{
		global $wpdb;
		$sql = "SELECT * FROM ".MM_TABLE_EVENT_LOG." WHERE id='".$this->id."'";
		$result = $wpdb->get_row($sql);

		if($result){
			$this->setData($result);
		}
		else {
			parent::invalidate();
		}
	}

	public function setData($data)
	{
		try 
		{
			$this->eventType = $data->event_type;
			$this->url = $data->url;
			$this->referrer = $data->referrer;
			$this->userId = $data->user_id;
			$this->ip = $data->ip;
			$this->additionalParams = $data->additional_params;
			
			if(!empty($this->additionalParams))
			{
				$this->additionalParams = unserialize($this->additionalParams);
			}
			else
			{
				$this->additionalParams = array();
			}

			parent::validate();
		}
		catch (Exception $ex) 
		{
			parent::invalidate();
		}
	}

	public function commitData()
	{
		global $wpdb;
		
		if(!MM_Employee::isEmployee($this->userId))
		{
			$eventLogData = array(
					"event_type" => $this->eventType,
					"url"        => $this->url,
					"referrer"	 => $this->referrer,
					"user_id"	 => $this->userId,
					"ip"		 => $this->ip,
					"date_modified"	=> MM_Utils::getCurrentTime()
			);
			if(intval($this->id)>0)
			{
				if(count($this->additionalParams) > 0)
				{
					$eventLogData['additional_params'] = serialize($this->additionalParams);
				}
				
				$whereClause = array("id"=>$this->id);
					
				$wpdb->update(MM_TABLE_EVENT_LOG,$eventLogData,$whereClause);
				return $this->id;
			}
			else
			{
				$eventLogData['date_added'] = MM_Utils::getCurrentTime();
				if(count($this->additionalParams) > 0) 
				{
					$eventLogData['additional_params'] = serialize($this->additionalParams);
				}
				
				$wpdb->insert(MM_TABLE_EVENT_LOG,$eventLogData);
				$this->id = $wpdb->insert_id;
				return $this->id;
			}
		}

		return false;
	}

	
	
	/** UTILITIES **/
	
	/**
	 * This method logs an event
	 * 
	 * @param MM_User $user the user to log an event for
	 * @param String $eventType the event type
	 * @param Array $params any parameters to store
	 */
	public static function log(MM_User $user, $eventType, $params=null)
	{
		if(!is_null($user) && $user->isValid())
		{
			$eventLog = new MM_EventLog();
			$eventLog->setEventType($eventType);
			$eventLog->setReferrer(MM_Utils::getReferrer());
			$eventLog->setIp(MM_Utils::getClientIPAddress());
			$eventLog->setUrl(MM_Utils::constructPageUrl());
			$eventLog->setUserId($user->getId());
			
			switch($eventLog->getEventType()) 
			{
				case MM_EventLog::$EVENT_TYPE_LOGIN:
					// update last login info on user
					$user->setLastLoginDate(MM_Utils::getCurrentTime());
					$user->commitData();
					$eventLog->commitData();
					break;
					
				case MM_EventLog::$EVENT_TYPE_PAGE_ACCESS:
					if(!is_null($params) && is_array($params) && count($params) > 0)
					{
						$eventLog->setAdditionalParams($params);
					}
					
					// don't store access to login page
					if(strpos($eventLog->getUrl(), "wp-login") === false)
					{
						$eventLog->commitData();
					}
					break;
			}
			
		}
	}
	
	/**
	 * This method checks if the member has reached their maximum allowable IP count within a 24 hour period.
	 * Each time a member logs in, the login event is logged along with their IP address. If the same member
	 * account has a number of IP addresses logging in within a 24 hour period this is a strong indication that
	 * the account credentials are being shared between multiple people. This method returns true if the member
	 * has surpassed the allowable IP address count within a 24 period.
	 * 
	 * @param String $memberId
	 * @return Boolean Rreturns true if the member has surpassed the allowable IP address count within a 24 period.
	 */
	public static function hasReachedMaxIPCount($memberId)
	{
		$enabled = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_ENABLED);
			
		if($enabled == "1")
		{
			global $wpdb;
			
			$maxIPs = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_MAX_IPS);
			$sql = "SELECT * FROM ".MM_TABLE_EVENT_LOG." WHERE event_type='".MM_EventLog::$EVENT_TYPE_LOGIN."' AND user_id='{$memberId}' and DATE(date_added)=DATE(NOW()) GROUP BY ip";
			$rows = $wpdb->get_results($sql);
	
			if(is_array($rows) && count($rows) > intval($maxIPs))
			{
				return true;
			}
		}
			
		return false;
	}
	
	public static function getPageAccessCount($memberId)
 	{
 		global $wpdb;
 	
 		$sql = "SELECT COUNT(DISTINCT url) as total FROM ".MM_TABLE_EVENT_LOG." WHERE event_type='".MM_EventLog::$EVENT_TYPE_PAGE_ACCESS."' AND user_id='{$memberId}' ";
 		$row = $wpdb->get_row($sql);
 			
 		if($row)
 		{
 			return $row->total;
 		}
 		else
 		{
 			return 0;
 		}
 	}
	
	public static function getLoginCount($memberId)
	{
		global $wpdb;
 	
 		$sql = "SELECT count(*) as total FROM ".MM_TABLE_EVENT_LOG." WHERE event_type='".MM_EventLog::$EVENT_TYPE_LOGIN."' AND user_id='{$memberId}'";
 		$row = $wpdb->get_row($sql);
 			
 		if($row)
 		{
 			return $row->total;
 		}
 		else
 		{
 			return 0;
 		}
	}
	
	public static function getLastLoginIpAddress($memberId)
	{
		global $wpdb;
		$sql = "SELECT ip FROM ".MM_TABLE_EVENT_LOG." WHERE ((event_type='".MM_EventLog::$EVENT_TYPE_LOGIN."') AND (user_id='{$memberId}')) ORDER BY date_added desc LIMIT 1;";
		$row = $wpdb->get_row($sql);
			
		if($row)
		{
			return $row->ip;
		}
		else
		{
			return "";
		}
	}
	
	public static function getEventsList()
	{
		$types = array(
			self::$EVENT_TYPE_PAGE_ACCESS => 'Page Access',
			self::$EVENT_TYPE_LOGIN => 'Login',
		);
	
		return $types;
	}
	
	
	
	/** GETTERS/SETTERS **/
	
	public function getEventType()
	{
		return $this->eventType;
	}

	public function setEventType($val)
	{
		$this->eventType = $val;
	}

	public function getUrl()
	{
		return $this->url;
	}

	public function setUrl($val)
	{
		$this->url = $val;
	}

	public function getReferrer()
	{
		return $this->referrer;
	}

	public function setReferrer($val)
	{
		$this->referrer = $val;
	}

	public function getUserId()
	{
		return $this->userId;
	}

	public function setUserId($val)
	{
		$this->userId = $val;
	}

	public function getAdditionalParams($arr)
	{
		return $this->additionalParams;
	}

	public function setAdditionalParams($arr)
	{
		$this->additionalParams = $arr;
	}

	public function getIp()
	{
		return $this->ip;
	}

	public function setIp($val)
	{
		$this->ip = $val;
	}
}
