<?php
/**
 * 
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 * 
 * MM_Install handles all install/update related tasks. The master schema is located in data/install_sql.php. 
 * Key things to remember when working with the master schema: 
 * 1. The wordpress dbdelta function is used to keep the schema in sync across versions. 
 *    Formatting is very important, please reference the initial schema when adding new tables
 * 2. PRIMARY KEYs need to be declared on a separate line (vs inline with the column definition. Two spaces need to
 *    follow the words PRIMARY KEY and the definition of that key, otherwise the dbdelta will fail
 * 3. FOREIGN KEYs are not currently supported and can potentially cause dbdeltas to fail.
 * 4. Each column or key definition needs to be on its own line. Lines are delimited by \n (unix-style newline)
 * 5. dbdelta() currently doesn't properly deal with backticks surrounding the column name in KEY definitions
 * 6. dbdelta() will add columns to existing tables, but will not drop removed columns. Those operations will need to be done manually 
 * 
 * With a properly formatted schema, the database structure will be synced to the schema on both install and update, eliminating the need for
 * version-specific update code and different code for installs vs updates. Default data with specified keys (either primary keys or unique column values) 
 * is inserted using INSERT IGNORE sql statements. This handles both insert and update scenarios because duplicate key errors are ignored if the data already exists.
 * 
 */
require_once(ABSPATH.'wp-admin/includes/upgrade.php');

 class MM_Install
 {
 	function __construct()
 	{
 		//default constructor
 	}
 	
 	public function activate()
 	{
 		global $wpdb;
 		ob_start();
 		
 		if(!defined("MM_TABLE_BUNDLES")) 
 		{
 			require_once(ABSPATH."wp-content/plugins/".MM_PLUGIN_NAME."/includes/mm-constants.php");
 		}
 		
 		$error = "";
 		
	 	if($this->createDBCache())
	 	{
	 		if($this->updateMemberMouseClass())
	 		{
	 			// reset minor version if this is a major version upgrade
	 			$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
	 			$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
	 			if (!empty($lastMajorVersion) && (version_compare($lastMajorVersion, $crntMajorVersion) < 0))
	 			{	
	 				MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION, MM_MemberMouseService::$DEFAULT_MINOR_VERSION); 
	 			}
	 			
		 		if($this->authenticateWithMM() !== false)
		 		{
		 			if($this->alterMMTables())
		 			{
		 				$this->temporaryStripePatch();
		 				if($this->insertMMDefaultData())
		 				{	 							
		 					// set new major version
		 					$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
		 					MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION, $crntMajorVersion);
		 					
		 					//update version history
		 					$versionDescription = $crntMajorVersion;
		 					$minorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION);
		 					
		 					if($minorVersion !== false && intval($minorVersion) > 0)
		 					{
		 						$versionDescription .= "-".$minorVersion;
		 					}
		 					else
		 					{
		 						$versionDescription .= "-".MM_MemberMouseService::$DEFAULT_MINOR_VERSION;
		 					}
		 					
 							$versionRelease = MM_VersionRelease::findByVersion($versionDescription);
 							$versionRelease->setVersion($versionDescription);
 							$versionRelease->commitData();
 							
 							MM_MemberMouseService::activatePlugin();
 							
 							// clear major version notice
 							$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
 							$upgradeVersion = MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE);
 							if(!empty($upgradeVersion) && (version_compare($crntMajorVersion, $upgradeVersion, ">=")))
 							{
 								MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE, "");
 							}
 							
 							ob_end_clean();
	 						return true;	
		 				}
				 		else 
				 		{
	 						$error = "Could not install default data.";
				 		}
		 			}
			 		else 
			 		{
	 					$error = "Could not alter MemberMouse tables.";
			 		}
		 		}
		 		else 
		 		{
		 			$error = "<div style='font-family: sans-serif; font-size: 13px;'>";
		 			
		 			$error .= "<h3 style='color:#BC0B0B; margin-top:0px; margin-bottom:5px; font-size: 14px;'>This site is not authorized to use the MemberMouse plugin</h3>";
		 			
		 			$error .= "<p style='margin-top:0px; margin-bottom:5px;'>In order to use the MemberMouse plugin you need to <a href=\"http://support.membermouse.com/customer/portal/articles/1046669-installing-membermouse\" target=\_blank\">register your site with membermouse.com</a>.</p>";
		 			
		 			$error .= "</div>";
		 		}
	 		}
	 		else 
	 		{
	 			$error = "Could not insert MM_MemberMouseService into DB cache";
	 		}
	 		
		}
		else 
		{
			$error = "Could not create DB cache";
		}
 		
	 	ob_end_clean();
	 	
 		// an error occurred so deactivate the plugin
		$this->showError($error);
		exit;
 	}
 	
 	
 	private function showError($error)
 	{
		$vars = new stdClass();
		$vars->content = $error;
		echo $error; 
		@deactivate_plugins(ABSPATH."wp-content/plugins/".MM_PLUGIN_NAME."/index.php", false);
 	}
 	
 	
 	private function createDBCache()
 	{
 		global $wpdb;
 		
 		require_once(ABSPATH.'wp-content/plugins/'.MM_PLUGIN_NAME."/data/db_cache_sql.php");
 	
		if(isset($sql) && count($sql) > 0)
		{
			foreach($sql as $query)
			{
				try
				{
					$result = $wpdb->query($query);
					if(!$result) 
					{
						return false;
					}
				}
				catch(Exception $e)
				{
					return false;
				}
			}
			
			$countSql = "select count(*) as total from ".MM_TABLE_CONTAINER." where name='membermouseservice'";
			$row = $wpdb->get_row($countSql);
			
			if($row===false)
			{
				return false;
			}	
		}
		
		return true;
 	}
 	
 	public function updateMemberMouseClass()
 	{
 		global $wpdb;
 		
 		$removeSql = "DELETE FROM ".MM_TABLE_CONTAINER." WHERE name='membermouseservice'";
		$row = $wpdb->get_row($removeSql);
		$wpdb->query($removeSql);
		
		$addSql = "INSERT INTO ".MM_TABLE_CONTAINER." (name, obj, is_system, date_added) values ('membermouseservice', 'Ci8qKgogKiAKICogTWVtYmVyTW91c2UoVE0pIChodHRwOi8vd3d3Lm1lbWJlcm1vdXNlLmNvbSkKICogKGMpIE1lbWJlck1vdXNlLCBMTEMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqLwpjbGFzcyBNTV9NZW1iZXJNb3VzZVNlcnZpY2UKewoJcHVibGljIHN0YXRpYyAkU0VSVkVSSVAgPSBNTV9DRU5UUkFMX1NFUlZFUjsgCgkKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX0lOVEVSVkFMID0gMjsKCXB1YmxpYyBzdGF0aWMgJERFRkFVTFRfTUlOT1JfVkVSU0lPTiA9ICIxMDAiOwoJCglwdWJsaWMgc3RhdGljICRVU0FHRV9QQUlEX01FTUJFUlMgPSAidXNhZ2VfcGFpZF9tZW1iZXJzIjsNCglwdWJsaWMgc3RhdGljICRVU0FHRV9GUkVFX01FTUJFUlMgPSAidXNhZ2VfZnJlZV9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX1BBSURfQlVORExFUyA9ICJ1c2FnZV9wYWlkX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkVVNBR0VfRlJFRV9CVU5ETEVTID0gInVzYWdlX2ZyZWVfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRVU0FHRV9PUkRFUlMgPSAidXNhZ2Vfb3JkZXJzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19QQVlNRU5UX01FVEhPRFMgPSAiY29uZmlnX3BheW1lbnRfbWV0aG9kcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfTUVNQkVSU0hJUFNfRlJFRSA9ICJjb25maWdfZnJlZV9tZW1iZXJzaGlwcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfTUVNQkVSU0hJUFNfUEFJRCA9ICJjb25maWdfcGFpZF9tZW1iZXJzaGlwcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfQlVORExFU19GUkVFID0gImNvbmZpZ19mcmVlX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0JVTkRMRVNfUEFJRCA9ICJjb25maWdfcGFpZF9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19QUk9EVUNUUyA9ICJjb25maWdfcHJvZHVjdHMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfRU1BSUwgPSAiY29uZmlnX2RmbHRfZW1wbG95ZWVfZW1haWwiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRSA9ICJjb25maWdfZGZsdF9lbXBsb3llZV9uYW1lIjsNCgkNCglwdWJsaWMgc3RhdGljICRQUk9QU19XUF9WRVJTSU9OID0gIndwX3ZlcnNpb24iOw0KCXB1YmxpYyBzdGF0aWMgJFBST1BTX1BIUF9WRVJTSU9OID0gInBocF92ZXJzaW9uIjsKCQ0KCXB1YmxpYyBzdGF0aWMgJE1FVEhPRF9BVVRIT1JJWkUgPSAiYXV0aG9yaXplUGx1Z2luIjsKCXB1YmxpYyBzdGF0aWMgJE1FVEhPRF9BQ1RJVkFURSA9ICJhY3RpdmF0ZVBsdWdpbiI7DQoJcHVibGljIHN0YXRpYyAkTUVUSE9EX0RFQUNUSVZBVEUgPSAiZGVhY3RpdmF0ZVBsdWdpbiI7CgkKCQ0KCQ0KCS8qKg0KCSAqIERldGVybWluZXMgaWYgdGhlIHBsdWdpbiBzaG91bGQgYXV0aG9yaXplIHdpdGggTU0gY2VudHJhbA0KCSAqLw0KCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGRvQXV0aG9yaXplKCkNCgl7DQoJCWlmKCFwcmVnX21hdGNoKCIvKHBsdWdpbnNcLnBocCkvIiwgJF9TRVJWRVJbIlBIUF9TRUxGIl0pKQ0KCQl7DQoJCQkkbGFzdENoZWNraW4gPSBiYXNlNjRfZGVjb2RlKE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xBU1RfQ0hFQ0tJTikpOw0KCQkJJG5leHRDaGVjayA9IHN0cnRvdGltZSgiKyIuc2VsZjo6JENIRUNLSU5fSU5URVJWQUwuIiBkYXkiLCBzdHJ0b3RpbWUoJGxhc3RDaGVja2luKSk7DQoJCQkkdG9kYXkgPSBkYXRlKCJZLW0tZCBoOmk6cyIpOw0KCQ0KCQkJaWYoc3RydG90aW1lKCR0b2RheSkgPj0gJG5leHRDaGVjaykNCgkJCXsNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCgkJCQkNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KCQ0KCQlyZXR1cm4gZmFsc2U7DQoJfQoJDQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBhdXRob3JpemUoJHJlZnJlc2hDbGFzc2VzPXRydWUpDQoJewoJCSR1cmwgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCJzaXRldXJsIik7DQoJCSR2ZXJzaW9uID0gTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZXRQbHVnaW5WZXJzaW9uKCk7DQoJCSRwb3N0dmFycyA9ICJ1cmw9Ii51cmxlbmNvZGUoJHVybCkuIiZ2ZXJzaW9uPSIuJHZlcnNpb247DQoJCSRtaW5vclZlcnNpb24gPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9NSU5PUl9WRVJTSU9OKTsNCg0KCQlpZigkbWlub3JWZXJzaW9uICE9PSBmYWxzZSAmJiBpbnR2YWwoJG1pbm9yVmVyc2lvbikgPiAwKQ0KCQl7DQoJCQkkcG9zdHZhcnMgLj0gIiZtaW5vcl92ZXJzaW9uPSIuJG1pbm9yVmVyc2lvbjsNCgkJfQoJCWVsc2UgCgkJewoJCQkkcG9zdHZhcnMgLj0gIiZtaW5vcl92ZXJzaW9uPSIuc2VsZjo6JERFRkFVTFRfTUlOT1JfVkVSU0lPTjsKCQl9CgkJCgkJaWYoY2xhc3NfZXhpc3RzKCJNTV9BcHBsaWVkQnVuZGxlIikpDQoJCXsKCQkJJHBvc3R2YXJzIC49ICImc3RhdGlzdGljcz0iLnVybGVuY29kZShqc29uX2VuY29kZShNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdlbmVyYXRlU3RhdGlzdGljcygpKSk7DQoJCX0KCQkNCgkJJHBvc3R2YXJzIC49ICImcHJvcGVydGllcz0iLnVybGVuY29kZShqc29uX2VuY29kZShNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdlbmVyYXRlUHJvcGVydGllcygpKSk7CgkJCgkJJHBvc3R2YXJzIC49ICImZ2V0X2NsYXNzZXM9Ii4oJHJlZnJlc2hDbGFzc2VzID8gIjEiIDogIjAiKTsKCQkNCgkJJGpzb25fZGF0YSA9IHNlbGY6OnNlbmRSZXF1ZXN0KHNlbGY6OiRNRVRIT0RfQVVUSE9SSVpFLCAkcG9zdHZhcnMpOwoJCQoJCWlmKCRqc29uX2RhdGEgPT09IGZhbHNlKQoJCXsKCQkJLy8gaXNzdWUgYXV0aG9yaXppbmcgd2l0aCBjZW50cmFsIHNlcnZlcgoJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sIGJhc2U2NF9lbmNvZGUoZGF0ZSgiWS1tLWQgaDppOnMiKSkpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9DQoJCWVsc2UgaWYoIXNlbGY6OmlzU3VjY2Vzc2Z1bFJlc3VsdCgkanNvbl9kYXRhKSkNCgkJewoJCQlpZihNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCQl7CgkJCQlzZWxmOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOwoJCQl9CgkJCQ0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJDQoJCSRqc29uID0gJGpzb25fZGF0YS0+cmVzcG9uc2VfZGF0YTsNCgkJcmV0dXJuIHNlbGY6OnVwZGF0ZUxpY2Vuc2VEYXRhKCRqc29uKTsNCgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gYWN0aXZhdGVQbHVnaW4oKQ0KCXsNCgkJJHBvc3R2YXJzID0gInVybD0iLk1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oInNpdGV1cmwiKTsNCgkJc2VsZjo6c2VuZFJlcXVlc3Qoc2VsZjo6JE1FVEhPRF9BQ1RJVkFURSwgJHBvc3R2YXJzKTsNCgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZGVhY3RpdmF0ZVBsdWdpbigpCgl7CgkJLy8gY2xlYXIgbGljZW5zZSBkYXRhDQoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfREFUQSwgIiIpOwoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xBU1RfQ0hFQ0tJTiwgIiIpOwoJCQoJCSRwb3N0dmFycyA9ICJ1cmw9Ii5NTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCJzaXRldXJsIik7CgkJc2VsZjo6c2VuZFJlcXVlc3Qoc2VsZjo6JE1FVEhPRF9ERUFDVElWQVRFLCAkcG9zdHZhcnMpOwoJfQoJCgkvKioKCSAqIFRoaXMgZnVuY3Rpb24gZm9yY2VzIGEgY2hlY2tpbgoJICovCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIHBpbmcoKQoJewoJCS8vIGNoZWNrIGlmIE1lbWJlck1vdXNlIHBsdWdpbiBpcyBhY3RpdmUNCgkJaWYoIU1NX1V0aWxzOjppc01lbWJlck1vdXNlQWN0aXZlKCkpDQoJCXsNCgkJCXJldHVybiBuZXcgTU1fUmVzcG9uc2UoIk1lbWJlck1vdXNlIHBsdWdpbiBpcyBjdXJyZW50bHkgZGVhY3RpdmF0ZWQiLCBNTV9SZXNwb25zZTo6JEVSUk9SKTsNCgkJfQoJCQoJCXJldHVybiBzZWxmOjphdXRob3JpemUoZmFsc2UpOwoJfQ0KCQ0KCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHVwZGF0ZUxpY2Vuc2VEYXRhKCRqc29uKQ0KCXsNCgkJaWYoaXNzZXQoJGpzb24tPmlzVmFsaWQpKQ0KCQl7CgkJCWlmKGlzc2V0KCRqc29uLT5saWNlbnNlRGF0YSkpCgkJCXsKCQkJCSRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoIiIsIGZhbHNlKTsKCQkJCSRsaWNlbnNlLT5zZXREYXRhKCRqc29uLT5saWNlbnNlRGF0YSk7CgkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sIGJhc2U2NF9lbmNvZGUoZGF0ZSgiWS1tLWQgaDppOnMiKSkpOwoJCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpzdG9yZUxpY2Vuc2UoJGxpY2Vuc2UpOwoJCQl9CgkJCQ0KCQkJaWYoIWVtcHR5KCRqc29uLT5jbGFzc2VzKSkKCQkJewkNCgkJCQlzZWxmOjpzYXZlRHluYW1pY0NsYXNzZXMoJGpzb24tPmNsYXNzZXMpOwoJCQl9CgkJCQoJCQlpZighZW1wdHkoJGpzb24tPm5vdGlmaWNhdGlvbnMpICYmIGlzX2FycmF5KCRqc29uLT5ub3RpZmljYXRpb25zKSkNCgkJCXsKCQkJCWZvcmVhY2goJGpzb24tPm5vdGlmaWNhdGlvbnMgYXMgJG5vdGlmaWNhdGlvbikKCQkJCXsKCQkJCQlzd2l0Y2goJG5vdGlmaWNhdGlvbi0+dHlwZSkNCgkJCQkJew0KCQkJCQkJY2FzZSAibWFqb3ItdmVyc2lvbi11cGdyYWRlIjoNCgkJCQkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9VUEdSQURFX05PVElDRSwgJG5vdGlmaWNhdGlvbi0+dmFsdWUpOw0KCQkJCQkJCWJyZWFrOwoJCQkJCQkJCgkJCQkJCWNhc2UgIm1pbm9yLXZlcnNpb24tdXBncmFkZSI6CiAgICAgICAgCQkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9NSU5PUl9WRVJTSU9OLCAkbm90aWZpY2F0aW9uLT52YWx1ZSk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCX0KCQkJCX0NCgkJCX0NCgkNCgkJCXJldHVybiB0cnVlOw0KCQl9DQoJDQoJCXJldHVybiBmYWxzZTsNCgl9CgkKCQoJLyoqIFVUSUxJVElFUyAqKi8KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gc2F2ZUR5bmFtaWNDbGFzc2VzKCRjbGFzc2VzKQoJewoJCWdsb2JhbCAkd3BkYjsKCQkKCQlpZihpc19vYmplY3QoJGNsYXNzZXMpIHx8IGlzX2FycmF5KCRjbGFzc2VzKSkKCQl7CgkJCSRzcWwgPSAiREVMRVRFIEZST00gIi5NTV9UQUJMRV9DT05UQUlORVIuIiBXSEVSRSBpc19zeXN0ZW09JzAnIjsKCQkJJHdwZGItPnF1ZXJ5KCRzcWwpOwoJCQkKCQkJZm9yZWFjaCgkY2xhc3NlcyBhcyAkY2xhc3NOYW1lPT4kY2xhc3NFbnRyeSkKCQkJewoJCQkJJHNxbCA9ICJJTlNFUlQgSU5UTyAiLk1NX1RBQkxFX0NPTlRBSU5FUi4iIFNFVCBuYW1lPSclcycsIG9iaj0nJXMnLCBkYXRlX2FkZGVkPU5PVygpIjsKCQkJCQoJCQkJaWYoc3RydG9sb3dlcigkY2xhc3NOYW1lKSA9PSAibWVtYmVybW91c2VzZXJ2aWNlIikKCQkJCXsKCQkJCQkkc3FsID0gIlVQREFURSAiLk1NX1RBQkxFX0NPTlRBSU5FUi4iIFNFVCBuYW1lPSclcycsIG9iaj0nJXMnLCBkYXRlX2FkZGVkPU5PVygpIHdoZXJlIG5hbWU9J21lbWJlcm1vdXNlc2VydmljZScgTElNSVQgMSI7CgkJCQl9CgkJCQkKCQkJCWlmKCR3cGRiLT5xdWVyeSgkd3BkYi0+cHJlcGFyZSgkc3FsLCAkY2xhc3NOYW1lLCAkY2xhc3NFbnRyeSkpKQoJCQkJewoJCQkJCSRjYWNoZVJlc3VsdCA9IHNlbGY6OmNhY2hlQ2xhc3MoJGNsYXNzTmFtZSwgJGNsYXNzRW50cnkpOwoJCQkJfQoJCQl9CgkJCQ0KCQkJTU1fU2Vzc2lvbjo6dmFsdWUoTU1fU2Vzc2lvbjo6JEtFWV9VU0lOR19EQl9DQUNIRSwgISRjYWNoZVJlc3VsdCk7CgkJfQoJCQoJCXJldHVybiB0cnVlOwoJfQoKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGNhY2hlQ2xhc3MoJGNsYXNzTmFtZSwgJGNsYXNzRW50cnkpCgl7CgkJJGZpbGVQYXRoID0gQUJTUEFUSC4id3AtY29udGVudC9wbHVnaW5zLyIuTU1fUExVR0lOX05BTUUuIi9jb20vbWVtYmVybW91c2UvY2FjaGUiOwoJCQoJCWlmKGlzX2RpcigkZmlsZVBhdGgpKQoJCXsKCQkJaWYoaXNfd3JpdGVhYmxlKCRmaWxlUGF0aCkpCgkJCXsKCQkJCWlmKHByZWdfbWF0Y2goIi8obWVtYmVybW91c2Vfc2NoZW1hKSQvIiwgJGNsYXNzTmFtZSkpCgkJCQl7CgkJCQkJJGZpbGVQYXRoIC49ICIvIi4kY2xhc3NOYW1lLiIuc3FsIjsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQkkZmlsZVBhdGggLj0gIi8iLmJhc2U2NF9lbmNvZGUoJGNsYXNzTmFtZSkuIi5jYWNoZSI7CgkJCQl9CgkJCQkKCQkJCSRmaCA9IGZvcGVuKCRmaWxlUGF0aCwgJ3cnKTsKCQkJCWZ3cml0ZSgkZmgsICRjbGFzc0VudHJ5KTsKCQkJCWZjbG9zZSgkZmgpOwoJCQkJCgkJCQlpZihmaWxlX2V4aXN0cygkZmlsZVBhdGgpKQoJCQkJewoJCQkJCUBjaG1vZCgkZmlsZVBhdGgsIDA3NzcpOwoJCQkJfQoJCQkJCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBzZW5kUmVxdWVzdCgkbWV0aG9kLCAkcG9zdHZhcnMpCgl7CgkJJHVybCA9IHNlbGY6OiRTRVJWRVJJUC4kbWV0aG9kOwoJCgkJJGNoID0gY3VybF9pbml0KCR1cmwpOwoJCWN1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9QT1NUICAgICAgLDEpOwoJCWN1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9QT1NURklFTERTICAgICwgJHBvc3R2YXJzKTsKCQljdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfSEVBREVSICAgICAgLDApOyAgLy8gRE8gTk9UIFJFVFVSTiBIVFRQIEhFQURFUlMKCQljdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfUkVUVVJOVFJBTlNGRVIgICwxKTsgIC8vIFJFVFVSTiBUSEUgQ09OVEVOVFMgT0YgVEhFIENBTEwKCQkkcmVzdWx0ID0gY3VybF9leGVjKCRjaCk7CgkJY3VybF9jbG9zZSgkY2gpOwoJCQoJCWlmKCRyZXN1bHQgPT09IGZhbHNlKQoJCXsKCQkJLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZWxzZSAKCQl7CgkJCUxvZ01lOjp3cml0ZShfX01FVEhPRF9fLiIgVVJMOiAiLiR1cmwuIiA6ICIuJHBvc3R2YXJzKTsKCQkJCgkJCSRqc29uID0ganNvbl9kZWNvZGUoJHJlc3VsdCk7CgkJCQoJCQlpZigkanNvbiAhPSBudWxsKQoJCQl7CgkJCQkkb3JpZ1Jlc3BvbnNlID0gJGpzb24tPnJlc3BvbnNlX2RhdGE7CgkJCQlpZihpc19zdHJpbmcoJGpzb24tPnJlc3BvbnNlX2RhdGEpKQoJCQkJewoJCQkJCSRqc29uLT5yZXNwb25zZV9kYXRhID0ganNvbl9kZWNvZGUoJGpzb24tPnJlc3BvbnNlX2RhdGEpOwoJCQkJCQkKCQkJCQlpZihpc19udWxsKCRqc29uLT5yZXNwb25zZV9kYXRhKSkKCQkJCQl7CgkJCQkJCSRqc29uLT5yZXNwb25zZV9kYXRhID0gJG9yaWdSZXNwb25zZTsKCQkJCQl9CgkJCQl9CgkJCQoJCQkJcmV0dXJuICRqc29uOwoJCQl9CgkJCWVsc2UgCgkJCXsKCQkJCS8vIGludmFsaWQgZGF0YSByZWNlaXZlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoJfQoNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGlzU3VjY2Vzc2Z1bFJlc3VsdCgkcmVzdWx0KQ0KCXsNCgkJaWYoIWlzX251bGwoJHJlc3VsdCkgJiYgKCRyZXN1bHQtPnJlc3BvbnNlX2NvZGUgPT0gIjIwMCIpKQ0KCQl7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfQ0KCQ0KCQlyZXR1cm4gZmFsc2U7DQoJfQoJCgkKCS8qKiBTSVRFIFNUQVRTIEFORCBQUk9QRVJUSUVTICoqLwoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlU3RhdGlzdGljcygpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCSRzdGF0aXN0aWNzID0gYXJyYXkoKTsKCQkKCQkvLyBQQUlEIE1FTUJFUlMgKFVTQUdFKQoJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudCh1LndwX3VzZXJfaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9VU0VSX0RBVEEuIiB1LCAiLk1NX1RBQkxFX01FTUJFUlNISVBfTEVWRUxTLiIgbSBXSEVSRSAiOwoJCSRiYXNlU3FsIC49ICJ1Lm1lbWJlcnNoaXBfbGV2ZWxfaWQgPSBtLmlkIEFORCB1LnN0YXR1cyA9ICciLk1NX1N0YXR1czo6JEFDVElWRS4iJyAiOwoJCQoJCSRyZXN1bHQgPSAkd3BkYi0+Z2V0X3JvdygkYmFzZVNxbC4iIEFORCBtLmlzX2ZyZWUgIT0gJzEnOyIpOwoJCQoJCWlmKCRyZXN1bHQpCgkJewoJCQkkcGFpZE1lbWJlcnMgPSAkcmVzdWx0LT50b3RhbDsKCQl9CgkJZWxzZQoJCXsKCQkJJHBhaWRNZW1iZXJzID0gMDsKCQl9CgkJCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX1BBSURfTUVNQkVSU10gPSAkcGFpZE1lbWJlcnM7CgkJCgkJLy8gRlJFRSBNRU1CRVJTIChVU0FHRSkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgbS5pc19mcmVlID0gJzEnOyIpOwoJCQoJCWlmKCRyZXN1bHQpCgkJewoJCQkkZnJlZU1lbWJlcnMgPSAkcmVzdWx0LT50b3RhbDsKCQl9CgkJZWxzZQoJCXsKCQkJJGZyZWVNZW1iZXJzID0gMDsKCQl9CgkJDQoJCSRzdGF0aXN0aWNzW3NlbGY6OiRVU0FHRV9GUkVFX01FTUJFUlNdID0gJGZyZWVNZW1iZXJzOwoJCQoJCS8vIFBBSUQgQlVORExFUyAoVVNBR0UpCgkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KDEpIGFzIHRvdGFsX2J1bmRsZXMgRlJPTSAiLk1NX1RBQkxFX0FQUExJRURfQlVORExFUy4iIGFwcEJ1bmRsZXMsIHskd3BkYi0+dXNlcnN9IHVzZXJzLCAiOw0KCQkkYmFzZVNxbCAuPSBNTV9UQUJMRV9CVU5ETEVTLiIgYnVuZGxlcyBXSEVSRSBhcHBCdW5kbGVzLmFjY2Vzc190eXBlPSciLk1NX0FwcGxpZWRCdW5kbGU6OiRBQ0NFU1NfVFlQRV9VU0VSLiInIEFORCBhcHBCdW5kbGVzLmFjY2Vzc190eXBlX2lkID0gdXNlcnMuaWQgIjsKCQkkYmFzZVNxbCAuPSAiQU5EIGFwcEJ1bmRsZXMuc3RhdHVzPSciLk1NX1N0YXR1czo6JEFDVElWRS4iJyBBTkQgYXBwQnVuZGxlcy5idW5kbGVfaWQgPSBidW5kbGVzLmlkICI7CgkJCgkJJHJlc3VsdCA9ICR3cGRiLT5nZXRfcm93KCRiYXNlU3FsLiIgQU5EIGJ1bmRsZXMuaXNfZnJlZSA9ICcwJzsiKTsKCQkKCQlpZigkcmVzdWx0KQoJCXsKCQkJJHBhaWRCdW5kbGVzID0gJHJlc3VsdC0+dG90YWxfYnVuZGxlczsKCQl9CgkJZWxzZQoJCXsKCQkJJHBhaWRCdW5kbGVzID0gMDsKCQl9CgkJCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX1BBSURfQlVORExFU10gPSAkcGFpZEJ1bmRsZXM7CgkJCgkJLy8gRlJFRSBCVU5ETEVTIChVU0FHRSkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgYnVuZGxlcy5pc19mcmVlID0gJzEnOyIpOwoJCQoJCWlmKCRyZXN1bHQpCgkJewoJCQkkZnJlZUJ1bmRsZXMgPSAkcmVzdWx0LT50b3RhbF9idW5kbGVzOwoJCX0KCQllbHNlCgkJewoJCQkkZnJlZUJ1bmRsZXMgPSAwOwoJCX0KCQkKCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfRlJFRV9CVU5ETEVTXSA9ICRmcmVlQnVuZGxlczsKCgkJLy8gT1JERVJTCgkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KG8uaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9PUkRFUlMuIiBvIjsKCQkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwpOw0KCQkNCgkJaWYoJHJlc3VsdCkNCgkJew0KCQkJJG9yZGVycyA9ICRyZXN1bHQtPnRvdGFsOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJG9yZGVycyA9IDA7DQoJCX0KCQkNCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX09SREVSU10gPSAkb3JkZXJzOwoJCQoJCS8vIFBBWU1FTlQgTUVUSE9EUwoJCSRwYXltZW50TWV0aG9kcyA9IGFycmF5KCk7CgkJCgkJJHNlcnZpY2VzID0gTU1fUGF5bWVudFNlcnZpY2VGYWN0b3J5OjpnZXRBdmFpbGFibGVQYXltZW50U2VydmljZXMoKTsNCgkJCQ0KCQlmb3JlYWNoICgkc2VydmljZXMgYXMgJHNlcnZpY2UpDQoJCXsNCgkJCWlmICgkc2VydmljZSBpbnN0YW5jZW9mIE1NX1BheW1lbnRTZXJ2aWNlKQ0KCQkJew0KCQkJCWFycmF5X3B1c2goJHBheW1lbnRNZXRob2RzLCAkc2VydmljZS0+Z2V0VG9rZW4oKSk7CgkJCX0KCQl9CgkJDQoJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfUEFZTUVOVF9NRVRIT0RTXSA9IGpvaW4oIiwgIiwgJHBheW1lbnRNZXRob2RzKTsKCQkKCQkvLyBQQUlEIE1FTUJFUlNISVAgTEVWRUxTCgkJJHBhaWRNZW1iZXJzaGlwcyA9IE1NX01lbWJlcnNoaXBMZXZlbDo6Z2V0TWVtYmVyc2hpcExldmVsc0xpc3QoZmFsc2UsIE1NX01lbWJlcnNoaXBMZXZlbDo6JFNVQl9UWVBFX1BBSUQpOwoJCQoJCWlmKCRwYWlkTWVtYmVyc2hpcHMgJiYgaXNfYXJyYXkoJHBhaWRNZW1iZXJzaGlwcykpCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IGNvdW50KCRwYWlkTWVtYmVyc2hpcHMpOwoJCX0KCQllbHNlIAoJCXsKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IDA7CgkJfQoJCQoJCS8vIEZSRUUgTUVNQkVSU0hJUCBMRVZFTFMKCQkkZnJlZU1lbWJlcnNoaXBzID0gTU1fTWVtYmVyc2hpcExldmVsOjpnZXRNZW1iZXJzaGlwTGV2ZWxzTGlzdChmYWxzZSwgTU1fTWVtYmVyc2hpcExldmVsOjokU1VCX1RZUEVfRlJFRSk7DQoJCQ0KCQlpZigkZnJlZU1lbWJlcnNoaXBzICYmIGlzX2FycmF5KCRmcmVlTWVtYmVyc2hpcHMpKQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX0ZSRUVdID0gY291bnQoJGZyZWVNZW1iZXJzaGlwcyk7DQoJCX0NCgkJZWxzZQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX0ZSRUVdID0gMDsNCgkJfQoJCQoJCS8vIFBBSUQgQlVORExFUw0KCQkkcGFpZEJ1bmRsZXMgPSBNTV9CdW5kbGU6OmdldEJ1bmRsZXNMaXN0KGZhbHNlLCBNTV9CdW5kbGU6OiRTVUJfVFlQRV9QQUlEKTsNCgkJDQoJCWlmKCRwYWlkQnVuZGxlcyAmJiBpc19hcnJheSgkcGFpZEJ1bmRsZXMpKQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfUEFJRF0gPSBjb3VudCgkcGFpZEJ1bmRsZXMpOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19CVU5ETEVTX1BBSURdID0gMDsNCgkJfQ0KCQkNCgkJLy8gRlJFRSBCVU5ETEVTDQoJCSRmcmVlQnVuZGxlcyA9IE1NX0J1bmRsZTo6Z2V0QnVuZGxlc0xpc3QoZmFsc2UsIE1NX0J1bmRsZTo6JFNVQl9UWVBFX0ZSRUUpOw0KCQkNCgkJaWYoJGZyZWVCdW5kbGVzICYmIGlzX2FycmF5KCRmcmVlQnVuZGxlcykpDQoJCXsNCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfQlVORExFU19GUkVFXSA9IGNvdW50KCRmcmVlQnVuZGxlcyk7DQoJCX0NCgkJZWxzZQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfRlJFRV0gPSAwOw0KCQl9CgkJCgkJLy8gUFJPRFVDVFMKCQkkcHJvZHVjdHMgPSBNTV9Qcm9kdWN0OjpnZXRBbGwoKTsKCQkKCQlpZigkcHJvZHVjdHMgJiYgaXNfYXJyYXkoJHByb2R1Y3RzKSkNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSBjb3VudCgkcHJvZHVjdHMpOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSAwOw0KCQl9CgkJCgkJLy8gREVGQVVMVCBFTVBMT1lFRSBBQ0NPVU5UCgkJJGVtcGxveWVlID0gTU1fRW1wbG95ZWU6OmdldERlZmF1bHQoKTsNCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19ERUZBVUxUX0VNUExPWUVFX0VNQUlMXSA9ICIiOw0KCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRV0gPSAiIjsKCQkKCQlpZigkZW1wbG95ZWUtPmlzVmFsaWQoKSkKCQl7CgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTF0gPSAkZW1wbG95ZWUtPmdldEVtYWlsKCk7CgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FXSA9ICRlbXBsb3llZS0+Z2V0RGlzcGxheU5hbWUoKTsKCQl9CgkJCgkJcmV0dXJuICRzdGF0aXN0aWNzOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlUHJvcGVydGllcygpCgl7CgkJZ2xvYmFsICR3cF92ZXJzaW9uOwoJCSRwcm9wZXJ0aWVzID0gYXJyYXkoKTsKCQkKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfV1BfVkVSU0lPTl0gPSAkd3BfdmVyc2lvbjsKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfUEhQX1ZFUlNJT05dID0gcGhwdmVyc2lvbigpOwoJCQoJCXJldHVybiAkcHJvcGVydGllczsKCX0KCQoJCgkvKiogUEVSTUlTU0lPTlMgKiovCgkNCglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQVVUSE9SSVpFTkVUID0gInB5bXRfc2VydmljZV9hdXRob3JpemVuZXQiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1BBWVBBTCA9ICJweW10X3NlcnZpY2VfcGF5cGFsIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9DTElDS0JBTksgPSAicHltdF9zZXJ2aWNlX2NsaWNrYmFuayI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQ0hBUkdJRlkgPSAicHltdF9zZXJ2aWNlX2NoYXJnaWZ5IjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9TVFJJUEUgPSAicHltdF9zZXJ2aWNlX3N0cmlwZSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQlJBSU5UUkVFID0gInB5bXRfc2VydmljZV9icmFpbnRyZWUiOwoJcHVibGljIHN0YXRpYyAkTUFYX05VTUJFUl9NRU1CRVJTID0gIm1heF9udW1iZXJfbWVtYmVycyI7CglwdWJsaWMgc3RhdGljICRTSE9XX01NX0ZPT1RFUiA9ICJzaG93X21tX2Zvb3RlciI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0JVTkRMRVMgPSAiZmVhdHVyZV9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfRFJJUF9DT05URU5UX1NDSEVEVUxFID0gImZlYXR1cmVfZHJpcF9jb250ZW50X3NjaGVkdWxlIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfUEhQX0lOVEVSRkFDRSA9ICJmZWF0dXJlX3BocF9pbnRlcmZhY2UiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9QVVNIX05PVElGSUNBVElPTlMgPSAiZmVhdHVyZV9wdXNoX25vdGlmaWNhdGlvbnMiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9BUEkgPSAiZmVhdHVyZV9hcGkiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9TTUFSVF9DT05URU5UX1RBR1MgPSAiZmVhdHVyZV9zbWFydF9jb250ZW50X3RhZ3MiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9BRkZJTElBVEVfTUdNVCA9ICJmZWF0dXJlX2FmZmlsaWF0ZV9tZ210IjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfTE9BRF9CQUxBTkNJTkcgPSAiZmVhdHVyZV9sb2FkX2JhbGFuY2luZyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0VNUExPWUVFX0FDQ09VTlRTID0gImZlYXR1cmVfZW1wbG95ZWVfYWNjb3VudHMiOwoJcHVibGljIHN0YXRpYyAkU1VQUE9SVF9FTUFJTCA9ICJzdXBwb3J0X2VtYWlsIjsKCXB1YmxpYyBzdGF0aWMgJFNVUFBPUlRfUEhPTkUgPSAic3VwcG9ydF9waG9uZSI7CglwdWJsaWMgc3RhdGljICRVTkxJTUlURURfTUVNQkVSUyA9IC0xOwoJCglwdWJsaWMgc3RhdGljICRBQ1RJVkUgPSAxOw0KCXB1YmxpYyBzdGF0aWMgJElOQUNUSVZFID0gMDsKCQ0KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gaGFzUGVybWlzc2lvbigka2V5KQ0KCXsNCgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOwoJCQoJCWlmKCRsaWNlbnNlLT5pc1ZhbGlkKCkpCgkJewoJCQkkcGVybWlzc2lvbnMgPSAkbGljZW5zZS0+Z2V0UGVybWlzc2lvbnMoKTsKCQkJCgkJCWlmKCRwZXJtaXNzaW9ucykKCQkJewoJCQkJJHBlcm1pc3Npb25zID0ganNvbl9kZWNvZGUoJHBlcm1pc3Npb25zKTsKCQkJCQ0KCQkJCWlmKGlzX29iamVjdCgkcGVybWlzc2lvbnMpICYmIGlzc2V0KCRwZXJtaXNzaW9ucy0+JGtleSkpDQoJCQkJew0KCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT4ka2V5Ow0KCQkJCX0KCQkJfQoJCQkKCQkJcmV0dXJuIHNlbGY6OiRJTkFDVElWRTsKCQl9DQoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldE1lbWJlckxpbWl0KCkKCXsKCQkkbGljZW5zZSA9IG5ldyBNTV9MaWNlbnNlKCk7DQoJCQ0KCQlpZigkbGljZW5zZS0+aXNWYWxpZCgpKQ0KCQl7DQoJCQkkcGVybWlzc2lvbnMgPSAkbGljZW5zZS0+Z2V0UGVybWlzc2lvbnMoKTsNCgkJCQkNCgkJCWlmKCRwZXJtaXNzaW9ucykNCgkJCXsNCgkJCQkkcGVybWlzc2lvbnMgPSBqc29uX2RlY29kZSgkcGVybWlzc2lvbnMpOwoJCQkJCgkJCQlpZihpc19vYmplY3QoJHBlcm1pc3Npb25zKSAmJiBpc3NldCgkcGVybWlzc2lvbnMtPm1heF9udW1iZXJfbWVtYmVycykpDQoJCQkJewoJCQkJCXJldHVybiAkcGVybWlzc2lvbnMtPm1heF9udW1iZXJfbWVtYmVyczsKCQkJCX0KCQkJfQoJCX0KCQkKCQlyZXR1cm4gLTE7Cgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2V0VXBncmFkZVVybCgkZmVhdHVyZT0iIikKCXsKCQkkbGljZW5zZSA9IG5ldyBNTV9MaWNlbnNlKCk7CgkJaWYoZW1wdHkoJGZlYXR1cmUpKQoJCXsKCQkJJHVybCA9ICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cGlkPSI7CgkJCQoJCQlzd2l0Y2goJGxpY2Vuc2UtPmdldHBlcm1pc3Npb25zUHJvZmlsZUlkKCkpCgkJCXsKCQkJCWNhc2UgMToKCQkJCQlyZXR1cm4gJHVybC4iMSI7CgoJCQkJY2FzZSAyOgoJCQkJCXJldHVybiAkdXJsLiIyIjsKCQkJCQkKCQkJCWNhc2UgMzogCgkJCQkJcmV0dXJuICR1cmwuIjMiOwoJCQkJCQoJCQkJZGVmYXVsdDoKCQkJCQlyZXR1cm4gJHVybC4iMyI7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJcmV0dXJuICJodHRwOi8vbWVtYmVybW91c2UuY29tL3VwZ3JhZGUucGhwP3Byb2ZpbGVpZD0iLiRsaWNlbnNlLT5nZXRwZXJtaXNzaW9uc1Byb2ZpbGVJZCgpLiImZmVhdHVyZT0iLiRmZWF0dXJlOwoJCX0KCX0NCgkNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldFBsdWdpblZlcnNpb24oKQ0KCXsNCgkJJGNvbnRlbnRzID0gZmlsZV9nZXRfY29udGVudHMoQUJTUEFUSC4id3AtY29udGVudC9wbHVnaW5zLyIuTU1fUExVR0lOX05BTUUuIi9pbmRleC5waHAiKTsNCgkJcHJlZ19tYXRjaCgiLyhcQHZlcnNpb24pWzAtOVwuXHNdKy8iLCAkY29udGVudHMsICRtYXRjaCk7DQoJCXJldHVybiAoKGlzc2V0KCRtYXRjaFswXSkpP3ByZWdfcmVwbGFjZSgiLyhcQHZlcnNpb24pW1xzXSsvIiwiIiwgdHJpbSgkbWF0Y2hbMF0pKToiIik7DQoJfQ0KCQ0KCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCkNCgl7DQoJCS8vIGlmIGxvZ2dlZCBpbiBhcyBhbiBhZG1pbiBhbmQgaW4gdGhlIGFkbWluIGFyZWEsIGRpc2FibGUgdGhlIHBsdWdpbiB0aHJvdWdoIFdvcmRQcmVzcywgb3RoZXJ3aXNlDQoJCS8vIG1hbnVhbGx5IGRlYWN0aXZhdGUgdGhlIHBsdWdpbiB0aHJvdWdoIHRoZSBkYXRhYmFzZQ0KCQlpZihpc19hZG1pbigpKQ0KCQl7DQoJCQkkZXJyb3IgPSAiVGhlIE1lbWJlck1vdXNlIHBsdWdpbiBjb3VsZCA8Yj5OT1Q8L2I+IGJlIGF1dGhlbnRpY2F0ZWQgYnkgbWVtYmVybW91c2UuY29tLiBUaGUgcGx1Z2luIHdpbGwgbm93IGJlIGRlYWN0aXZhdGVkLiI7DQoJCQloZWFkZXIoIkxvY2F0aW9uOiBwbHVnaW5zLnBocD8iLk1NX1Nlc3Npb246OiRQQVJBTV9DT01NQU5EX0RFQUNUSVZBVEUuIj0xJiIuTU1fU2Vzc2lvbjo6JFBBUkFNX01FU1NBR0VfS0VZLiI9Ii51cmxlbmNvZGUoJGVycm9yKSk7DQoJCQlleGl0Ow0KCQl9DQoJCWVsc2UNCgkJew0KCQkJc2VsZjo6bWFudWFsbHlEZWFjdGl2YXRlUGx1Z2luKCk7DQoJCX0NCgl9DQoJDQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gbWFudWFsbHlEZWFjdGl2YXRlUGx1Z2luKCkNCgl7DQoJCSRwbHVnaW5zID0gZ2V0X29wdGlvbignYWN0aXZlX3BsdWdpbnMnKTsNCgkNCgkJaWYoaXNfYXJyYXkoJHBsdWdpbnMpICYmIGNvdW50KCRwbHVnaW5zKSA+IDApDQoJCXsNCgkJCSRwbHVnaW5OYW1lID0gTU1fUExVR0lOX05BTUUuIi9pbmRleC5waHAiOw0KCQkJJGtleSA9IGFycmF5X3NlYXJjaCgkcGx1Z2luTmFtZSwgJHBsdWdpbnMsIHRydWUpOw0KCQkJCQ0KCQkJaWYoJGtleSAhPT0gZmFsc2UpDQoJCQl7DQoJCQkJdW5zZXQoJHBsdWdpbnNbJGtleV0pOw0KCQkJfQ0KCQkJCQ0KCQkJdXBkYXRlX29wdGlvbigiYWN0aXZlX3BsdWdpbnMiLCAkcGx1Z2lucyk7DQoJCQkKCQkJLy8gc2VuZCBhbiBlbWFpbCB0byB0aGUgZGVmYXVsdCBlbXBsb3llZQoJCQkkZW1wbG95ZWUgPSBNTV9FbXBsb3llZTo6Z2V0RGVmYXVsdCgpOwoJCQkkZW1haWwgPSBuZXcgTU1fRW1haWwoKTsNCgkJCSRlbWFpbC0+c2V0Q29udGV4dChuZXcgTU1fQ29udGV4dCgpKTsNCgkJCSRlbWFpbC0+c2V0U3ViamVjdCgiTWVtYmVyTW91c2UgZGVhY3RpdmF0ZWQgb24gIi5nZXRfb3B0aW9uKCdzaXRldXJsJykpOw0KCQkJJGVtYWlsLT5zZXRGcm9tTmFtZSgiTWVtYmVyTW91c2UgTm90aWZpY2F0aW9uIik7DQoJCQkkZW1haWwtPnNldEZyb21BZGRyZXNzKCJkby1ub3QtcmVwbHlAbWVtYmVybW91c2UuY29tIik7CgkJCSRlbWFpbC0+YWRkQ0MoInN1cHBvcnRAbWVtYmVybW91c2UuY29tIiwgIk1lbWJlck1vdXNlIFN1cHBvcnQiKTsNCgkJCSRlbWFpbC0+c2V0VG9OYW1lKCRlbXBsb3llZS0+Z2V0Rmlyc3ROYW1lKCkpOw0KCQkJJGVtYWlsLT5zZXRUb0FkZHJlc3MoJGVtcGxveWVlLT5nZXRFbWFpbCgpKTsKCQkJCgkJCSRib2R5ID0gIk1lbWJlck1vdXNlIGhhcyBiZWVuIGRlYWN0aXZhdGVkIG9uICIuZ2V0X29wdGlvbignc2l0ZXVybCcpLiIuXG5cblRoaXMgaXMgbW9zdCBsaWtlbHkgYmVjYXVzZSB5b3VyIE1lbWJlck1vdXNlIGxpY2Vuc2UgaGFzIGV4cGlyZWQuXG5cbiI7CgkJCSRib2R5IC49ICJJZiB5b3UgdGhpbmsgdGhpcyB3YXMgZG9uZSBpbiBlcnJvciwgcGxlYXNlIGNvbnRhY3QgdXMgYXQgc3VwcG9ydEBtZW1iZXJtb3VzZS5jb20uXG5cblRoYW5rIHlvdSxcbk1lbWJlck1vdXNlIFN1cHBvcnQgVGVhbSI7DQoJCQkkZW1haWwtPnNldEJvZHkoJGJvZHkpOw0KCQkJCgkJCSRlbWFpbC0+c2VuZCgpOwoJCQkNCgkJCXNlbGY6OmRlYWN0aXZhdGVQbHVnaW4oKTsNCgkJfQ0KCX0KCQoJCgkvKiogTElDRU5TRSBIRUxQRVIgTUVUSE9EUyAqKi8KCS8qKgoJICogVGhlIGZvbGxvd2luZyBtZXRob2RzIGFyZSBhc3NvY2lhdGVkIHdpdGggYW5kIGNhbGxlZCBmcm9tIHRoZSBNTV9MaWNlbnNlIGNsYXNzLiBUaGV5J3JlIHB1dCBoZXJlIHRvIGVuc3VyZQoJICogdGhlIGhpZ2hlc3QgbGV2ZWwgb2Ygc2VjdXJpdHkgaG93ZXZlciB0aGUgYXBwbGljYXRpb24gc2hvdWxkbid0IGludGVyYWN0IHdpdGggdGhlbSBkaXJlY3RseSBvbiB0aGlzIGNsYXNzLAoJICogdGhleSBzaG91bGQgdXNlIE1NX0xpY2Vuc2UgYXMgdGhlIG1haW4gb2JqZWN0IHRvIGludGVyZmFjdCB3aXRoLgoJICovCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldExpY2Vuc2UoTU1fTGljZW5zZSAkbGljZW5zZSkKCXsKCQlpZihNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmRvQXV0aG9yaXplKCkgJiYgIU1NX01lbWJlck1vdXNlU2VydmljZTo6YXV0aG9yaXplKGZhbHNlKSkKCQl7CgkJCU1NX01lbWJlck1vdXNlU2VydmljZTo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKTsKCQl9DQoJCWVsc2UNCgkJewkKCQkJLy8gaWYgbGljZW5zZSBkYXRhIGlzbid0IGluIHNlc3Npb24gb3IgbmVlZHMgdG8gYmUgcmVmcmVzaGVkLCBnZXQgaXQgZnJvbSB0aGUgZGF0YWJhc2UgCgkJCS8vIGFuZCBzdG9yZSBpdCBpbiB0aGUgc2Vzc2lvbgoJCQlpZighTU1fU2Vzc2lvbjo6dmFsdWUoTU1fU2Vzc2lvbjo6JEtFWV9NTV9MSUNFTlNFKSB8fCAKCQkJCQlNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX1JFRlJFU0gpID09ICIxIikKCQkJewoJCQkJJGxpY2Vuc2VEYXRhID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBKTsKCQkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfUkVGUkVTSCwgIjAiKTsKCQkJCU1NX1Nlc3Npb246OnZhbHVlKE1NX1Nlc3Npb246OiRLRVlfTU1fTElDRU5TRSwgJGxpY2Vuc2VEYXRhKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCSRsaWNlbnNlRGF0YSA9IE1NX1Nlc3Npb246OnZhbHVlKE1NX1Nlc3Npb246OiRLRVlfTU1fTElDRU5TRSk7CgkJCX0NCgkJDQoJCQlpZigkbGljZW5zZURhdGEpDQoJCQl7CQoJCQkJLy8gZGVjcnlwdCBsaWNlbnNlIGRhdGEKCQkJCSRsaWNlbnNlRGF0YSA9IHVuc2VyaWFsaXplKGJhc2U2NF9kZWNvZGUoJGxpY2Vuc2VEYXRhKSk7CgkJCQkKCQkJCSRsaWNlbnNlLT5zZXRJZCgkbGljZW5zZURhdGEtPmlkKTsNCgkJCQkkbGljZW5zZS0+c2V0TWVtYmVySWQoJGxpY2Vuc2VEYXRhLT5tZW1iZXJJZCk7DQoJCQkJJGxpY2Vuc2UtPnNldE5hbWUoJGxpY2Vuc2VEYXRhLT5uYW1lKTsNCgkJCQkkbGljZW5zZS0+c2V0VXJsKCRsaWNlbnNlRGF0YS0+dXJsKTsNCgkJCQkkbGljZW5zZS0+c2V0QXBpS2V5KCRsaWNlbnNlRGF0YS0+YXBpS2V5KTsNCgkJCQkkbGljZW5zZS0+c2V0QXBpU2VjcmV0KCRsaWNlbnNlRGF0YS0+YXBpU2VjcmV0KTsNCgkJCQkkbGljZW5zZS0+c2V0TWFqb3JWZXJzaW9uKCRsaWNlbnNlRGF0YS0+bWFqb3JWZXJzaW9uKTsNCgkJCQkkbGljZW5zZS0+c2V0TWlub3JWZXJzaW9uKCRsaWNlbnNlRGF0YS0+bWlub3JWZXJzaW9uKTsNCgkJCQkkbGljZW5zZS0+c2V0UGVybWlzc2lvbnNQcm9maWxlSWQoJGxpY2Vuc2VEYXRhLT5wZXJtaXNzaW9uc1Byb2ZpbGVJZCk7DQoJCQkJJGxpY2Vuc2UtPnNldFBlcm1pc3Npb25zKCRsaWNlbnNlRGF0YS0+cGVybWlzc2lvbnMpOw0KCQkJCSRsaWNlbnNlLT5zZXRTdGF0dXMoJGxpY2Vuc2VEYXRhLT5zdGF0dXMpOw0KCQkJCSRsaWNlbnNlLT5zZXRMYXN0VXBkYXRlZCgkbGljZW5zZURhdGEtPmxhc3RVcGRhdGVkKTsNCgkJCQkkbGljZW5zZS0+c2V0RGF0ZUFkZGVkKCRsaWNlbnNlRGF0YS0+ZGF0ZUFkZGVkKTsNCgkJCQkkbGljZW5zZS0+c2V0QXV0aEtleShiYXNlNjRfZW5jb2RlKGdldF9vcHRpb24oInNpdGV1cmwiKSkpOw0KCQkJCSRsaWNlbnNlLT52YWxpZGF0ZSgpOw0KCQkJfQ0KCQkJZWxzZSBpZihNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQ0KCQkJew0KCQkJCU1NX01lbWJlck1vdXNlU2VydmljZTo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKTsNCgkJCX0NCgkJfQoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIHN0b3JlTGljZW5zZShNTV9MaWNlbnNlICRsaWNlbnNlKQoJewoJCSRsaWNlbnNlRGF0YSA9IGJhc2U2NF9lbmNvZGUoc2VyaWFsaXplKHNlbGY6OnBhY2thZ2VVcExpY2Vuc2VEYXRhKCRsaWNlbnNlKSkpOwoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfUkVGUkVTSCwgIjEiKTsKCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX0RBVEEsICRsaWNlbnNlRGF0YSk7Cgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gdmFsaWRhdGVMaWNlbnNlKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJJGF1dGhLZXkgPSBiYXNlNjRfZGVjb2RlKCRsaWNlbnNlLT5nZXRBdXRoS2V5KCkpOwoJCQoJCWlmKGVtcHR5KCRhdXRoS2V5KSB8fCAkYXV0aEtleSAhPSBnZXRfb3B0aW9uKCJzaXRldXJsIikpCgkJewoJCQlzZWxmOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBwYWNrYWdlVXBMaWNlbnNlRGF0YShNTV9MaWNlbnNlICRsaWNlbnNlKQoJewoJCSRkYXRhID0gbmV3IHN0ZENsYXNzKCk7CgkKCQkkZGF0YS0+aWQgPSAkbGljZW5zZS0+Z2V0SWQoKTsKCQkkZGF0YS0+bWVtYmVySWQgPSAkbGljZW5zZS0+Z2V0TWVtYmVySWQoKTsKCQkkZGF0YS0+bmFtZSA9ICRsaWNlbnNlLT5nZXROYW1lKCk7CgkJJGRhdGEtPnVybCA9ICRsaWNlbnNlLT5nZXRVcmwoKTsKCQkkZGF0YS0+YXBpS2V5ID0gJGxpY2Vuc2UtPmdldEFwaUtleSgpOwoJCSRkYXRhLT5hcGlTZWNyZXQgPSAkbGljZW5zZS0+Z2V0QXBpU2VjcmV0KCk7CgkJJGRhdGEtPm1ham9yVmVyc2lvbiA9ICRsaWNlbnNlLT5nZXRNYWpvclZlcnNpb24oKTsKCQkkZGF0YS0+bWlub3JWZXJzaW9uID0gJGxpY2Vuc2UtPmdldE1pbm9yVmVyc2lvbigpOwoJCSRkYXRhLT5wZXJtaXNzaW9uc1Byb2ZpbGVJZCA9ICRsaWNlbnNlLT5nZXRwZXJtaXNzaW9uc1Byb2ZpbGVJZCgpOwoJCSRkYXRhLT5wZXJtaXNzaW9ucyA9ICRsaWNlbnNlLT5nZXRQZXJtaXNzaW9ucygpOwoJCSRkYXRhLT5zdGF0dXMgPSAkbGljZW5zZS0+Z2V0U3RhdHVzKCk7CgkJJGRhdGEtPmlzQXJjaGl2ZWRGbGFnID0gJGxpY2Vuc2UtPmlzQXJjaGl2ZWQoKTsKCQkkZGF0YS0+bGFzdFVwZGF0ZWQgPSAkbGljZW5zZS0+Z2V0TGFzdFVwZGF0ZWQoKTsKCQkkZGF0YS0+ZGF0ZUFkZGVkID0gJGxpY2Vuc2UtPmdldERhdGVBZGRlZCgpOwoJCgkJcmV0dXJuICRkYXRhOwoJfQoJCgkKCS8qKiBQUk9URUNURUQgVVRJTElURVMgKiovDQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBlbmNyeXB0UGFzc3dvcmQoJHBhc3N3b3JkKQ0KCXsNCgkJZm9yKCRpPTA7ICRpPDU7ICRpKyspDQoJCXsNCgkJCSRwYXNzd29yZCA9IHN0cnJldihiYXNlNjRfZW5jb2RlKCRwYXNzd29yZCkpOw0KCQl9DQoJCQkNCgkJcmV0dXJuICRwYXNzd29yZDsNCgl9DQoNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGRlY3J5cHRQYXNzd29yZCgkcGFzc3dvcmQpDQoJew0KCQlmb3IoJGk9MDsgJGk8NTsgJGkrKykNCgkJew0KCQkJJHBhc3N3b3JkID0gYmFzZTY0X2RlY29kZShzdHJyZXYoJHBhc3N3b3JkKSk7DQoJCX0NCg0KCQlyZXR1cm4gJHBhc3N3b3JkOw0KCX0KfQoK', '1', NOW());";
		if($wpdb->query($addSql) === false)
		{	
			return false;
		}
		return true;
 	}
 	
 	public function authenticateWithMM()
 	{
 		if(class_exists("MM_MemberMouseService"))
 		{
	 		return MM_MemberMouseService::authorize();
 		}
 		return false;
 	}
 	
 	private function alterMMTables()
 	{
 		global $wpdb;
 		
 		$filename = "install_sql";
 		require_once(ABSPATH.'wp-content/plugins/'.MM_PLUGIN_NAME."/data/{$filename}.php");	

		if (isset($sql) && count($sql)>0)
		{
			dbdelta($sql);
		}
		
 		return true;
 	} 	
 	
 	private function hasRecords($table, $column, $where)
 	{
 		global $wpdb;
 		
 		$sql = "select count(*) as total from {$table} where {$column}='".addslashes($where)."'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
 	}
 	
 	
 	private function insertMMDefaultData()
 	{
 		global $wpdb, $current_user;
		
 		// insert default option values
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_ENABLED, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_MAX_IPS, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_MAX_IPS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ON_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_ON_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFTER_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_AFTER_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_LOGIN_LOGOUT_LINK, MM_OptionUtils::$DEFAULT_SHOW_LOGIN_LOGOUT_LINK);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_PROTECTED_MENU_ITEMS, MM_OptionUtils::$DEFAULT_HIDE_PROTECTED_MENU_ITEMS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_COUNTRY_SELECTIONS, MM_OptionUtils::$DEFAULT_COUNTRY_SELECTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_SUBJECT, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_SUBJECT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_BODY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE, MM_OptionUtils::$DEFAULT_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE, MM_OptionUtils::$DEFAULT_SUB_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, MM_OptionUtils::$DEFAULT_AFFILIATE_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_LOGIN_TOKEN_LIFESPAN, MM_OptionUtils::$DEFAULT_LOGIN_TOKEN_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_CHECKOUT_FORM_TEST_DATA, MM_OptionUtils::$DEFAULT_USE_CHECKOUT_FORM_TEST_DATA);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_WIDTH, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_WIDTH);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_HEIGHT, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_HEIGHT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_TYPE, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_TYPE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_ID, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_ID);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_PREVIEW_BAR, MM_OptionUtils::$DEFAULT_SHOW_PREVIEW_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_ADMIN_BAR, MM_OptionUtils::$DEFAULT_HIDE_ADMIN_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_LOGGED_OUT_PURCHASES, MM_OptionUtils::$DEFAULT_ALLOW_LOGGED_OUT_PURCHASES);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_PAID_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_PAID_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_FREE_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_FREE_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_MESSAGE_CSS, MM_OptionUtils::$DEFAULT_CHECKOUT_MESSAGE_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY, MM_OptionUtils::$DEFAULT_CURRENCY);
		
		// options that vary based on if this is an upgrade versus a new install
		$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
		
		if(empty($lastMajorVersion))
		{
			// set options for new installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, MM_OptionUtils::$DEFAULT_DISABLE_EXPLICIT_LINKS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_OptionUtils::$DEFAULT_PURCHASE_LINK_STYLE);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, MM_OptionUtils::$DEFAULT_SMARTTAG_VERSION);
		}
		else
		{
			// set options for existing installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_LINK_STYLE_EXPLICIT);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, "2.0");
		}
		
 		$sql = array();
 		
 		MM_Role::addRoles();
 		
	 	// create default employee account if one doesn't exist, using the current user
	 	$install_sql = "select * from ".MM_TABLE_EMPLOYEE_ACCOUNTS." where is_default='1' LIMIT 1;";
	 	$row = $wpdb->get_row($install_sql);
	 	if($row == null)
	 	{
	 		//the current user isn't an employee
	 		$install_sql = "insert into ".MM_TABLE_EMPLOYEE_ACCOUNTS." set display_name='%s', email='%s', is_default='%d', role_id='%s', user_id='%d'";
	 		$displayName = (!empty($current_user->display_name)) ? $current_user->display_name : "Support";
	 		$wpdb->query($wpdb->prepare($install_sql, $displayName, $current_user->user_email, 1, MM_Role::$ROLE_ADMINISTRATOR, $current_user->ID));
	 		$emailId = $wpdb->insert_id;
	 	}
	 	else 
	 	{
	 		$emailId = $row->id;
	 	}
	 	
	 	// install default overdue payment notification email
	 	$crntValue = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED);
	 	if($crntValue === false || $crntValue === "")
	 	{
	 		$action = new MM_Action();
	 		$action->setEventType(MM_Event::$MEMBER_STATUS_CHANGE);
	 		$action->setActionType(MM_Action::$MM_ACTION_SEND_EMAIL);
	 			
	 		$emailToId = MM_Action::$CURRENT_MEMBER_PLACEHOLDER;
	 		$emailFromId = $emailId;
	 		$emailCC = "";
	 		$emailSubject = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_SUBJECT;
	 		$emailBody = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_BODY;
	 		$action->setActionValue(MM_Action::prepareSendEmailValue($emailToId, $emailFromId, $emailCC, $emailSubject, $emailBody));
	 			
	 		// set attributes
	 		$attributes = array();
	 		$attributes["status_id"] = MM_Status::$OVERDUE;
	 		$action->setEventAttributes($attributes);
	 		
	 		$result = $action->commitData();
	 		
	 		if(MM_Response::isSuccess($result))
	 		{
	 			MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED, "1");
	 		}
	 	}
	 	
 		// create default membership level
	 	if(!$this->hasRecords(MM_TABLE_MEMBERSHIP_LEVELS, 'is_default', '1'))
	 	{
		 	$install_sql = "INSERT INTO ".MM_TABLE_MEMBERSHIP_LEVELS." SET " .
			 			"	name = 'Free Membership'," .
			 			"	is_free='1'," .
			 			"	is_default='1'," .
			 			"	status='1'," .
			 			"	description='Default Free Membership'," .
			 			"	email_subject='%s'," .
			 			"	email_body='%s'," .
			 			"	email_from_id='%d'" .
			 			"";
		 	
		 	$wpdb->query($wpdb->prepare($install_sql, MM_MembershipLevel::$DFLT_EMAIL_SUBJECT, MM_MembershipLevel::$DFLT_EMAIL_BODY, $emailId));
	 	}
	 	
	 	// create default commission profile
	 	if(!$this->hasRecords(MM_TABLE_COMMISSION_PROFILES, 'is_default', '1'))
	 	{
	 		$install_sql = "INSERT INTO ".MM_TABLE_COMMISSION_PROFILES." SET " .
	 				"	name = 'Standard Commission Profile'," .
		 			"	is_default='1'," .
		 			"	description='This is the default commission profile'," .
		 			"	initial_commission_enabled='1'," .
		 			"	rebill_commissions_enabled='0'," .
		 			"	rebill_commission_type='default'," .
		 			"	rebill_commission_value='0'," .
		 			"	do_limit_rebill_commissions='0'," .
		 			"	rebill_commission_limit='0', " .
		 			"	do_reverse_commissions='1'" .
	 				"";
	 	
	 		$wpdb->query($wpdb->prepare($install_sql));
	 	}
	 	
 		foreach($sql as $query)
 		{
 			if($wpdb->query($query) === false)
 			{
 				return false;
 			}
 		} 		
 		unset($sql);
 		
 		//add smart tags
	 	$this->addSmartTags();
	 	
	 	$sql = "select count(*) as total from ".MM_TABLE_API_KEYS;
	 	$row = $wpdb->get_row($sql);
	 	
	 	if($row->total<=0)
	 	{
	 		$sql = "insert into ".MM_TABLE_API_KEYS." set ".
		 		   "name='Default Access', ".
		 		   "api_key='".MM_Utils::createRandomString(10)."',	".
		 		   "api_secret='".MM_Utils::createRandomString(10)."', ".
		 		   "status='1'";
	 		
		 	$wpdb->query($sql);
	 	}
	 	
	 	$sql = array();
	 	require_once(ABSPATH.'wp-content/plugins/'.MM_PLUGIN_NAME."/data/countries.sql.php");
	 	$numCountries = count($sql);
	 	$countryCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRIES;
	 	$row = $wpdb->get_row($countryCheckSql);
	 	if ($row->total < $numCountries)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
	 	
	 	$result = $this->setupCorePages();
	 	
	 	if(!$result)
	 	{
	 		return false;
	 	}
	 	
	 	$cacheWriteable = @MM_Utils::cacheIsWriteable();
	 		
	 	$sql = array();
	 		
	 	//TODO TRANSIENT: in version 2.0.1 renamed WordPress Mail to None. Once all customers have been upgraded to None then this 
	 	// if statement can be removed
	 	if($this->hasRecords(MM_TABLE_EMAIL_SERVICE_PROVIDERS, 'provider_token', 'default'))
	 	{
	 		$sql[] = "UPDATE ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None' WHERE provider_token='default';";
	 	}
	 	else 
	 	{
	 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	}
	 	
	 	//email service providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='MailChimp', provider_token='mailchimp', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='iContact', provider_token='icontact', api_key='".MM_IContactEmailServiceProvider::$API_KEY."'";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='AWeber', provider_token='aweber', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='GetResponse', provider_token='getresponse', active='0';";
	 	
	 	//affiliate providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='iDevAffiliate', provider_token='idevaffiliate';";
	 		
	 	//payment services
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='PAYPAL', name='PayPal', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENET', name='Authorize.net', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='BRAINTREE', name='Braintree', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CHARGIFY', name='Chargify', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STRIPE', name='Stripe', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CLICKBANK', name='ClickBank', settings='', active='0';";
	 	
	 	//shipping methods
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_SHIPPING_METHODS." SET token='FLATRATE', name='Flat Rate', settings='', active='1';"; //active by default
	 	
	 	foreach ($sql as $query)
	 	{
	 		$wpdb->query($query);
	 	}
	 	unset($sql);
	 	
	 	//apply any updates that may have been made to the schemas of the active payment services
	 	$activePaymentServices = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 	foreach ($activePaymentServices as $ps)
	 	{
	 		$ps->install();
	 	}
	 	
	 	return true;
 	}
 	
 	
 	private function setupCorePages()
 	{
 		global $wpdb, $current_user;
 		
 		// Core Page Types
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MEMBER_HOME_PAGE."','Member Home','1');";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$SAVETHESALE."','Save the Sale','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$ERROR."','Error','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGIN_PAGE."','Login','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FORGOT_PASSWORD."','Forgot Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$CHECKOUT."','Checkout','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$PAID_CONFIRMATION."','Confirmation','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FREE_CONFIRMATION."','Free Confirmation','0');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MY_ACCOUNT."','My Account','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGOUT_PAGE."','Logout','1');";
 			
	 	// Default Core Pages
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('1', '".MM_CorePageType::$MEMBER_HOME_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('2', '".MM_CorePageType::$SAVETHESALE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('3', '".MM_CorePageType::$ERROR."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('4', '".MM_CorePageType::$LOGIN_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('5', '".MM_CorePageType::$FORGOT_PASSWORD."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('6', '".MM_CorePageType::$CHECKOUT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('7', '".MM_CorePageType::$PAID_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('9', '".MM_CorePageType::$FREE_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('10', '".MM_CorePageType::$MY_ACCOUNT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('11', '".MM_CorePageType::$LOGOUT_PAGE."');";
	 	
	 	foreach($sql as $query)
	 	{
	 		if($wpdb->query($query) === false)
	 		{
	 			echo $query;
	 			return false;
	 		}
	 	}
	 	unset($sql);
 		
	 	///wp-posts pages	
 		$install_sql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where page_id IS NOT NULL ";
 		$row = $wpdb->get_row($install_sql);
	 	
	 	if($row->total <= 0)
	 	{	
	 		$templateParams = new stdClass();
	 		$templateParams->resourceDirectory = MM_RESOURCES_URL;
	 		$mm_template_base= ABSPATH."wp-content/plugins/".MM_PLUGIN_NAME."/templates";
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/homepage.html.php", $templateParams))."', '[MM_Member_Data name=\"membershipName\"] Home Page', '".$this->getPostName('home')."');";
	 		
 			if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MEMBER_HOME_PAGE);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/cancel.html.php", $templateParams))."', 'Cancel Membership', '".$this->getPostName('cancel')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$SAVETHESALE);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/error.html.php", $templateParams))."', 'Error', '".$this->getPostName('mm-error')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$ERROR);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/login.html.php", $templateParams))."', 'Login', '".$this->getPostName('login')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGIN_PAGE);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/logout.html.php", $templateParams))."', 'Logout', '".$this->getPostName('logout')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGOUT_PAGE);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/forgotpassword.html.php", $templateParams))."', 'Forgot Password', '".$this->getPostName('forgot-password')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$FORGOT_PASSWORD);
 			
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/checkout.html.php", $templateParams))."', 'Checkout', '".$this->getPostName('checkout')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$CHECKOUT);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/myaccount.html.php", $templateParams))."', 'My Account', '".$this->getPostName('myaccount')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MY_ACCOUNT);
	 		
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/confirmation.html.php", $templateParams))."', 'Thank You', '".$this->getPostName('confirmation')."');";
	 			
	 		if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$PAID_CONFIRMATION);
	 	}
	 	
 		return true;
 	}
 	
 	private function addSmartTags()
 	{
 		global $wpdb;
 		require_once(ABSPATH.'wp-content/plugins/'.MM_PLUGIN_NAME."/data/smarttags.sql.php");
 		if(isset($sql) && is_array($sql))
 		{
 			foreach($sql as $query)
 			{
 				if($wpdb->query($query)===false){ 
 					return false;	
 				}
 			}
 		}
 		return true;
 	}
 	
 	private function getPostName($suggestedName=""){
 		global $wpdb;
 		$sql = "select count(*) as total from {$wpdb->posts} where post_name='".$suggestedName."'";
 		$row = $wpdb->get_row($sql);
 		if($row->total>0){
	 		$sql = "select post_name from {$wpdb->posts} where post_name like '".$suggestedName."-%'";
	 		$rows = $wpdb->get_results($sql);
	 		
	 		$index=1;
	 		while(true){
	 			$newName = $suggestedName."-".$index;
	 			$hasName = false;
	 			foreach($rows as $row){
	 				if($row->post_name == $newName){
	 					$hasName = true;		
	 				}
	 			}
	 			if(!$hasName){
	 				return $newName;
	 			}
	 			$index++;
	 		}
 		}
 		return $suggestedName;
 	}
 	
 	private function linkCorePage($page_id, $id)
 	{
		global $wpdb;
		$sql = "update ".MM_TABLE_CORE_PAGES." set page_id='{$page_id}' where id='{$id}'";
		
		if(!$wpdb->query($sql))
		{
			echo $sql;
			return false;
		}
 	}
 	
	private function field_exists($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
	
		for($i=0; $i<count($rows); $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return true;
			}
		}
		
		return false;
	}
	
	private function getFieldType($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
		
		$numRows = count($rows);
		for($i=0; $i<$numRows; $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return $rows[$i]->Type;
			}
		}
		
		return false;
	}
	
	private function temporaryStripePatch()
	{
		global $wpdb;
		
		if ($this->field_exists("scheduled_event_id", MM_TABLE_SCHEDULED_PAYMENTS))
		{
			$outOfSync = $wpdb->get_var("SELECT count(*) FROM ".MM_TABLE_SCHEDULED_PAYMENTS." WHERE scheduled_event_id != id");
			if (($outOfSync != null) && ($outOfSync > 0))
			{
				$wpdb->query("ALTER TABLE ".MM_TABLE_SCHEDULED_PAYMENTS." CHANGE id id BIGINT(20) UNSIGNED NOT NULL");
				$wpdb->query("DROP INDEX mm_scheduled_payments_event_id_fk_idx ON ".MM_TABLE_SCHEDULED_PAYMENTS);
				$maxes = $wpdb->get_row("select max(id) as id_max, max(scheduled_event_id) AS event_max FROM ".MM_TABLE_SCHEDULED_PAYMENTS);
				$patchDirection = ($maxes->event_max >= $maxes->id_max)?"DESC":"ASC";
				$scheduledPayments = $wpdb->get_results("SELECT id,scheduled_event_id FROM ".MM_TABLE_SCHEDULED_PAYMENTS." ORDER BY scheduled_event_id {$patchDirection}");
				foreach ($scheduledPayments as $scheduledPayment)
				{
					$wpdb->query("UPDATE ".MM_TABLE_SCHEDULED_PAYMENTS." SET id='{$scheduledPayment->scheduled_event_id}' WHERE scheduled_event_id='{$scheduledPayment->scheduled_event_id}'");
				}
				$wpdb->query("ALTER TABLE ".MM_TABLE_SCHEDULED_PAYMENTS." DROP COLUMN scheduled_event_id");
			}
		}
	}
 }